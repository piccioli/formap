# HTTP: redirect a HTTPS + percorso per challenge Let's Encrypt (per certbot futuro)
<VirtualHost *:80>
    ServerName sicai-accreditamento.montagnaservizi.it

    # Per certificato Let's Encrypt (certbot --webroot)
    Alias /.well-known/acme-challenge /var/www/acme-sicai
    <Directory /var/www/acme-sicai>
        Require all granted
    </Directory>

    # Redirect a HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

    ErrorLog ${APACHE_LOG_DIR}/sicai-accreditamento.montagnaservizi.it_error.log
    CustomLog ${APACHE_LOG_DIR}/sicai-accreditamento.montagnaservizi.it_access.log combined
</VirtualHost>

# HTTPS: reverse proxy verso container formap (certificato Let's Encrypt)
<VirtualHost *:443>
    ServerName sicai-accreditamento.montagnaservizi.it

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/sicai-accreditamento.montagnaservizi.it/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/sicai-accreditamento.montagnaservizi.it/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Challenge ACME anche su 443 (se il client arriva in HTTPS)
    Alias /.well-known/acme-challenge /var/www/acme-sicai
    <Directory /var/www/acme-sicai>
        Require all granted
    </Directory>

    ProxyPreserveHost On
    ProxyPass /.well-known/acme-challenge !
    ProxyPass / http://127.0.0.1:8080/
    ProxyPassReverse / http://127.0.0.1:8080/
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    ErrorLog ${APACHE_LOG_DIR}/sicai-accreditamento.montagnaservizi.it_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/sicai-accreditamento.montagnaservizi.it_ssl_access.log combined
    ProxyTimeout 300
</VirtualHost>
